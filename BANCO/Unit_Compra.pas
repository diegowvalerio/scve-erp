unit Unit_Compra;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, Buttons, ExtCtrls, Grids, DBGrids, ComCtrls, DB,
  IBCustomDataSet, Mask, DBCtrls, IBStoredProc, CurrEdit, ToolEdit,
  RXDBCtrl, RxMemDS, IBDatabase, IBSQL, IBQuery, sEdit, sSpinEdit;

type
  TForm_Mov_Compra = class(TForm)
    PageControl1: TPageControl;
    Tab_Pesquisa: TTabSheet;
    Tab_Compra: TTabSheet;
    Rg_tipo: TRadioGroup;
    GroupBox1: TGroupBox;
    Edit1: TEdit;
    btb_finalizar: TBitBtn;
    panel_cabecalho: TGroupBox;
    Edit2: TEdit;
    Label1: TLabel;
    Label2: TLabel;
    edit_fornecdor: TDBLookupComboBox;
    Label3: TLabel;
    Label5: TLabel;
    panel_itens: TGroupBox;
    DBGrid2: TDBGrid;
    SP_Compra: TIBStoredProc;
    Edit_total: TCurrencyEdit;
    RxMemoria: TRxMemoryData;
    DsMemoria: TDataSource;
    RxMemoriacod_produto: TIntegerField;
    RxMemoriadescricao: TStringField;
    RxMemoriaqtde: TFloatField;
    RxMemoriapreco_custo: TFloatField;
    RxMemoriasub_total: TFloatField;
    ExecutaSql: TIBSQL;
    TExecutaSql: TIBTransaction;
    Q_Compra: TIBQuery;
    DsCompra: TDataSource;
    Edit3: TDBDateEdit;
    Q_Compra_item: TIBQuery;
    btn_voltar: TBitBtn;
    DBGrid3: TDBGrid;
    Q_caixa: TIBQuery;
    Label9: TLabel;
    DateEdit1: TDateEdit;
    Q_CompraID_COMPRA: TIntegerField;
    Q_CompraDT_COMPRA: TDateField;
    Q_CompraVL_TOTAL: TFloatField;
    Q_CompraID_FORNECEDOR: TIntegerField;
    Q_CompraNOME_FORNECEDOR: TIBStringField;
    Q_Compra_itemID_COMPRA: TIntegerField;
    Q_Compra_itemID_PRODUTO: TIntegerField;
    Q_Compra_itemQUANTIDADE: TIntegerField;
    Q_Compra_itemPRECO_CUSTO: TFloatField;
    Q_Compra_itemNOME_PRODUTO: TIBStringField;
    Q_caixaID_CAIXA: TIntegerField;
    Q_caixaVL_INICIAL: TFloatField;
    Q_caixaDT_INICIAL: TDateField;
    Q_caixaVL_FECHA: TFloatField;
    Q_caixaDT_FECHA: TDateField;
    TabSheet1: TTabSheet;
    Tab_Conta_pagar: TIBDataSet;
    Tab_Conta_pagarID_CONTA_PAGAR: TIntegerField;
    Tab_Conta_pagarVL_TOTAL_FATURA: TFloatField;
    Tab_Conta_pagarVL_TOTAL_PAGO: TFloatField;
    Tab_Conta_pagarHISTORICO: TIBStringField;
    Tab_Conta_pagarID_COMPRA: TIntegerField;
    Ds_conta_pagar: TDataSource;
    GroupBox2: TGroupBox;
    Label10: TLabel;
    DBEdit1: TDBEdit;
    Label13: TLabel;
    DBEdit4: TDBEdit;
    Label11: TLabel;
    DBEdit2: TDBEdit;
    DBEdit3: TDBEdit;
    Label12: TLabel;
    Label14: TLabel;
    DBEdit5: TDBEdit;
    GroupBox3: TGroupBox;
    CurrencyEdit1: TCurrencyEdit;
    CurrencyEdit2: TCurrencyEdit;
    DateEdit2: TDateEdit;
    Label15: TLabel;
    Label16: TLabel;
    Label17: TLabel;
    BitBtn1: TBitBtn;
    BitBtn4: TBitBtn;
    DBGrid1: TDBGrid;
    Rx_Parcela: TRxMemoryData;
    DsMemoria_Parcela: TDataSource;
    Rx_Parcelavl_parcela: TFloatField;
    Rx_Parceladt_vencimento: TDateField;
    GroupBox4: TGroupBox;
    Edit4: TEdit;
    Label4: TLabel;
    CurrencyEdit4: TCurrencyEdit;
    Label19: TLabel;
    BitBtn5: TBitBtn;
    Rx_Parcelanun_parc: TIntegerField;
    Label20: TLabel;
    CurrencyEdit5: TCurrencyEdit;
    BitBtn6: TBitBtn;
    Label18: TLabel;
    CurrencyEdit3: TCurrencyEdit;
    Tab_Conta_pagarID_FORNECEDOR: TIntegerField;
    Label21: TLabel;
    DBEdit6: TDBEdit;
    RadioGroup1: TRadioGroup;
    DBImage1: TDBImage;
    Label6: TLabel;
    edit_produto: TDBLookupComboBox;
    Label7: TLabel;
    Label8: TLabel;
    Edit_precocusto: TCurrencyEdit;
    BitBtn2: TBitBtn;
    BitBtn3: TBitBtn;
    Edit_quantidade: TCurrencyEdit;
    btn_fechar: TBitBtn;
    btn_cancelar: TBitBtn;
    btn_visualizar: TBitBtn;
    btn_incluir: TBitBtn;
    Tab_Conta_pagarDTVENCIMENTO: TDateField;
    Button1: TButton;
    DateEdit3: TDateEdit;
    procedure btn_fecharClick(Sender: TObject);
    procedure habilita_botoes;
    procedure desabilita_botoes;
    procedure btn_incluirClick(Sender: TObject);
    procedure PageControl1Changing(Sender: TObject;
      var AllowChange: Boolean);
    procedure btb_finalizarClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure limpa_edts_itens;
    procedure limpa_edts_compra;
    procedure btn_cancelarClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure Edit_datavctExit(Sender: TObject);
    procedure panel_cabecalhoExit(Sender: TObject);
    procedure RxMemoriaCalcFields(DataSet: TDataSet);
    procedure BitBtn2Click(Sender: TObject);
    procedure calcula_total;
    procedure BitBtn3Click(Sender: TObject);
    procedure Edit_quantidadeExit(Sender: TObject);
    procedure btn_visualizarClick(Sender: TObject);
    procedure btn_voltarClick(Sender: TObject);
    procedure Edit1Change(Sender: TObject);
    procedure DateEdit1Exit(Sender: TObject);
    procedure BitBtn1Click(Sender: TObject);
    procedure BitBtn4Click(Sender: TObject);
    procedure Edit4Exit(Sender: TObject);
    procedure BitBtn5Click(Sender: TObject);
    procedure BitBtn6Click(Sender: TObject);
    procedure TabSheet1Enter(Sender: TObject);
    procedure RadioGroup1Click(Sender: TObject);
    procedure edit_produtoExit(Sender: TObject);
    procedure DBGrid2CellClick(Column: TColumn);
    procedure Button1Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form_Mov_Compra: TForm_Mov_Compra;
   nun_parc , i: integer;
   
implementation

uses Unit_DM;

{$R *.dfm}

procedure TForm_Mov_Compra.btn_fecharClick(Sender: TObject);
begin
Close;
end;

procedure TForm_Mov_Compra.Habilita_botoes;
begin
 btn_incluir.enabled := True;
 btn_visualizar.enabled := True;
 btn_cancelar.enabled := True;
 btn_fechar.enabled := True;
 
end;

procedure TForm_Mov_Compra.Desabilita_botoes;
begin
 btn_incluir.enabled := False;
 btn_visualizar.enabled := False;
 btn_cancelar.enabled := False;
 btn_fechar.enabled := False;
end;
procedure TForm_Mov_Compra.btn_incluirClick(Sender: TObject);
begin
panel_cabecalho.Enabled := True;
panel_itens.Enabled := True;
btb_finalizar.Enabled := True;
btn_cancelar.Enabled := True;
btn_incluir.Enabled := false;
btn_visualizar.Enabled := False;
btn_fechar.Enabled := False;
RxMemoria.Close;
PageControl1.ActivePage := Tab_Compra;
Edit3.Date := (Now);
//Edit_datavct.Date := (now + 1);
Edit3.SetFocus;
    DBImage1.Visible := False;

SP_Compra.ExecProc;
Edit2.Text := SP_Compra.Parambyname ('numero').AsString;
end;

procedure TForm_Mov_Compra.PageControl1Changing(Sender: TObject;
  var AllowChange: Boolean);
begin
AllowChange:= False;
end;

procedure TForm_Mov_Compra.btb_finalizarClick(Sender: TObject);
//var i : integer;
begin

if i= 0 then begin
if Application.MessageBox('Deseja Finalizar Compra','SOF CONTROL', MB_yesno + MB_Iconquestion) = Id_YES then begin

  Try
    TExecutaSql.StartTransaction;
    ExecutaSql.Close;
    ExecutaSql.SQL.Clear;
    ExecutaSql.SQL.Add('insert into tab_compra(id_compra,id_fornecedor, dt_compra,vl_total)');
    ExecutaSql.SQL.Add('values (:p_id_compra, :p_id_fornecedor, :p_dt_compra,:p_vl_total)');
    ExecutaSql.ParamByName('p_id_compra').AsInteger := StrToInt(Edit2.Text);
    ExecutaSql.ParamByName('p_id_fornecedor').AsInteger := edit_fornecdor.KeyValue;
    ExecutaSql.ParamByName('p_dt_compra').AsDate := Edit3.Date;
    //ExecutaSql.ParamByName('p_dtvct').AsDate := Edit_datavct.Date;
    ExecutaSql.ParamByName('p_vl_total').AsFloat := Edit_total.Value;
    ExecutaSql.ExecQuery;


    RxMemoria.First;
    while not RxMemoria.Eof do
    begin
      ExecutaSql.Close;
      ExecutaSql.SQL.Clear;
      ExecutaSql.SQL.Add('insert into tab_item_compra (id_compra, id_produto, quantidade,preco_custo)');
      ExecutaSql.SQL.Add('values (:p_id_compra, :p_id_produto, :p_quantidade, :p_preco_custo)');
      ExecutaSql.ParamByName('p_id_compra').AsInteger := StrToInt(Edit2.Text);
      ExecutaSql.ParamByName('p_id_produto').AsFloat := RxMemoriacod_produto.AsInteger;
      ExecutaSql.ParamByName('p_quantidade').AsFloat := RxMemoriaqtde.AsFloat;
      ExecutaSql.ParamByName('p_preco_custo').AsFloat := RxMemoriapreco_custo.AsFloat;
      ExecutaSql.ExecQuery;
      RxMemoria.Next;
    end;

    //if Edit_datavct.Date > (now) then begin
     // ExecutaSql.Close;
     // ExecutaSql.SQL.Clear;
     // ExecutaSql.SQL.Add('insert into tab_conta_pagar(cod_lancamento,COD_FORNECEDOR,dt_vencimento,vr_fatura,vr_pago, historico)');
     // ExecutaSql.SQL.Add('values (gen_id(g_conta_pagar,1), :p_COD_FORNECEDOR, :p_dt_vencimento, :p_vr_fatura,:p_vr_pago, :p_historico)');
     // ExecutaSql.ParamByName('p_COD_FORNECEDOR').AsInteger := edit_fornecdor.KeyValue;
     // ExecutaSql.ParamByName('p_dt_vencimento').AsDate := Edit_datavct.Date;
     // ExecutaSql.ParamByName('p_vr_fatura').AsFloat := Edit_total.Value;
     // ExecutaSql.ParamByName('p_vr_pago').AsFloat := 0;
     // ExecutaSql.ParamByName('p_historico').AsString := 'GERADO PELO MOVIMENTO DE COMPRA!!';
     // ExecutaSql.ExecQuery;
   // end;

    RxMemoria.First;
    while not RxMemoria.Eof do
    begin
      ExecutaSql.Close;
      ExecutaSql.SQL.Clear;
      ExecutaSql.SQL.Add('update tab_produto set qtdestoque = qtdestoque + :p_quantidade where nome_produto = :p_id_produto');
      ExecutaSql.ParamByName('p_quantidade').AsFloat  := RxMemoriaqtde.AsFloat;
      ExecutaSql.ParamByName('p_id_produto').AsVariant := RxMemoriadescricao.AsVariant;
      ExecutaSql.ExecQuery;
      RxMemoria.Next;
    end;

    DateEdit2.Date := Date;
    Q_caixa.Active := True;
if DateEdit2.Date = (date) then begin
    Q_caixa.First;
    while NOT Q_caixa.Eof do begin
      if Q_caixaVL_FECHA.Value = 0 then begin
      ExecutaSql.Close;
      ExecutaSql.SQL.Clear;
      ExecutaSql.SQL.Add('insert into TAB_item_CAIXA(num_lanc,ID_CAIXA,TIPO_LANC,VL_LANC,HISTORICO)');
      ExecutaSql.SQL.Add('values (gen_id(GEN_TAB_ITEM_CAIXA_ID,1),:p_id_caixa,:p_TIPO_LANC, :p_VL_LANC, :p_HISTORICO)');
      ExecutaSql.ParamByName('p_id_caixa').AsInteger := Q_caixaID_CAIXA.AsInteger;
      ExecutaSql.ParamByName('p_TIPO_LANC').AsString := 'D';
      ExecutaSql.ParamByName('p_VL_LANC').AsCurrency := Edit_total.Value;
      ExecutaSql.ParamByName('p_HISTORICO').AsString := 'GERADO PELO MOVIMENTO DE COMPRA!!! N°'+Edit2.Text+'';
      ExecutaSql.ExecQuery;
      end;
    Q_caixa.Next;
    end;
end;

    TExecutaSql.Commit;
    ShowMessage('A Compra de Nr° ['+ Edit2.Text +']foi gravada com sucesso!');

  Except
    TExecutaSql.Rollback;
    ShowMessage('Erro. Não foi possivel gravar Compra Nr° ['+ Edit2.Text +']!');
  end;
end;
i := -1;
   Q_Compra.Close;
     Q_Compra.Open;
btb_finalizar.Enabled := False;
btn_cancelar.Enabled := False;
btn_incluir.Enabled := True;
btn_visualizar.Enabled := True;
btn_fechar.Enabled := True;
limpa_edts_compra;
limpa_edts_itens;
PageControl1.ActivePage := Tab_Pesquisa;
end;

if i = 1 then begin
PageControl1.ActivePage := TabSheet1;
Tab_Conta_pagar.Active := true;
Tab_Conta_pagar.Insert;
Tab_Conta_pagarVL_TOTAL_FATURA.Value := Edit_total.Value;
Tab_Conta_pagarVL_TOTAL_PAGO.Value := 0;
Tab_Conta_pagarID_COMPRA.AsInteger := StrToInt(Edit2.Text);
Tab_Conta_pagarHISTORICO.AsString := 'GERADO PELO MOVIMENTO DE COMPRA!!!';
Tab_Conta_pagarID_FORNECEDOR.Value := edit_fornecdor.KeyValue;


//Tab_Conta_pagarDTVENCIMENTO.Value :=  Rx_Parceladt_vencimento.Value;
 CurrencyEdit3.Value := Tab_Conta_pagarVL_TOTAL_FATURA.Value;


end;

if i = 3 then begin
if Application.MessageBox('Deseja Finalizar Compra','SOF CONTROL', MB_yesno + MB_Iconquestion) = Id_YES then begin

  Try

    TExecutaSql.StartTransaction;
    ExecutaSql.Close;
    ExecutaSql.SQL.Clear;
    ExecutaSql.SQL.Add('insert into tab_compra(id_compra,id_fornecedor, dt_compra,vl_total)');
    ExecutaSql.SQL.Add('values (:p_id_compra, :p_id_fornecedor, :p_dt_compra,:p_vl_total)');
    ExecutaSql.ParamByName('p_id_compra').AsInteger := StrToInt(Edit2.Text);
    ExecutaSql.ParamByName('p_id_fornecedor').AsInteger := edit_fornecdor.KeyValue;
    ExecutaSql.ParamByName('p_dt_compra').AsDate := Edit3.Date;
    //ExecutaSql.ParamByName('p_dtvct').AsDate := Edit_datavct.Date;
    ExecutaSql.ParamByName('p_vl_total').AsFloat := Edit_total.Value;
    ExecutaSql.ExecQuery;


    RxMemoria.First;
    while not RxMemoria.Eof do
    begin
      ExecutaSql.Close;
      ExecutaSql.SQL.Clear;
      ExecutaSql.SQL.Add('insert into tab_item_compra (id_compra, id_produto, quantidade,preco_custo)');
      ExecutaSql.SQL.Add('values (:p_id_compra, :p_id_produto, :p_quantidade, :p_preco_custo)');
      ExecutaSql.ParamByName('p_id_compra').AsInteger := StrToInt(Edit2.Text);
      ExecutaSql.ParamByName('p_id_produto').AsFloat := RxMemoriacod_produto.AsInteger;
      ExecutaSql.ParamByName('p_quantidade').AsFloat := RxMemoriaqtde.AsFloat;
      ExecutaSql.ParamByName('p_preco_custo').AsFloat := RxMemoriapreco_custo.AsFloat;
      ExecutaSql.ExecQuery;
      RxMemoria.Next;
    end;

    Rx_Parcela.First;
    while not Rx_Parcela.Eof do
     begin
     ExecutaSql.Close;
     ExecutaSql.SQL.Clear;
     ExecutaSql.SQL.Add('insert into tab_parcela(id_conta_pagar,vl_parcela,dt_vencimento,num_parc)');
     ExecutaSql.SQL.Add('values (:p_id_conta_pagar, :p_vl_parcela, :p_dt_vencimento, :p_num_parc)');
     ExecutaSql.ParamByName('p_id_conta_pagar').AsInteger := Tab_Conta_pagarID_CONTA_PAGAR.Value;
     ExecutaSql.ParamByName('p_vl_parcela').AsDouble := Rx_Parcelavl_parcela.Value;
     ExecutaSql.ParamByName('p_dt_vencimento').AsDate := Rx_Parceladt_vencimento.Value;
     ExecutaSql.ParamByName('p_num_parc').AsInteger := Rx_Parcelanun_parc.Value;
     ExecutaSql.ExecQuery;
     Rx_Parcela.Next;
   end;


    RxMemoria.First;
    while not RxMemoria.Eof do
    begin
      ExecutaSql.Close;
      ExecutaSql.SQL.Clear;
      ExecutaSql.SQL.Add('update tab_produto set qtdestoque = qtdestoque + :p_quantidade where nome_produto = :p_id_produto');
      ExecutaSql.ParamByName('p_quantidade').AsFloat  := RxMemoriaqtde.AsFloat;
      ExecutaSql.ParamByName('p_id_produto').AsVariant := RxMemoriadescricao.AsVariant;
      ExecutaSql.ExecQuery;
      RxMemoria.Next;
    end;

//if DateEdit2.Date = (date) then begin
   // Q_caixa.First;
    //while NOT Q_caixa.Eof do begin
     // if Q_caixaVL_FECHA.Value = 0 then begin
     // ExecutaSql.Close;
     // ExecutaSql.SQL.Clear;
     // ExecutaSql.SQL.Add('insert into TAB_item_CAIXA(ID_CAIXA,TIPO_LANC,VL_LANC,HISTORICO)');
     // ExecutaSql.SQL.Add('values (gen_id(GEN_TAB_ITEM_CAIXA_ID,1), :p_ID_CAIXA, :p_VL_LANC, :p_HISTORICO)');
     // ExecutaSql.ParamByName('p_TIPO_LANC').AsString := 'D';
     // ExecutaSql.ParamByName('p_VL_LANC').AsCurrency := Edit_total.Value;
     // ExecutaSql.ParamByName('p_HISTORICO').AsString := 'GERADO PELO MOVIMENTO DE COMPRA!!!';
    //  ExecutaSql.ParamByName('p_NR_CAIXA').AsInteger := Q_caixaID_CAIXA.AsInteger;
    //  ExecutaSql.ExecQuery;
   //   end;
   // Q_caixa.Next;
    //end;
//end;


    DateEdit3.Date := Rx_Parceladt_vencimento.AsDateTime;
    Tab_Conta_pagarDTVENCIMENTO.Value := DateEdit3.Date;

    TExecutaSql.Commit;

    ShowMessage('A Compra de Nr° ['+ Edit2.Text +']foi gravada com sucesso!');

  Except
    TExecutaSql.Rollback;

    ShowMessage('Erro. Não foi possivel gravar Compra Nr° ['+ Edit2.Text +']!');
  end;
  Tab_Conta_pagar.Post;
end;
 Q_Compra.Close;
     Q_Compra.Open;
btb_finalizar.Enabled := False;
btn_cancelar.Enabled := False;
btn_incluir.Enabled := True;
btn_visualizar.Enabled := True;
btn_fechar.Enabled := True;
limpa_edts_compra;
limpa_edts_itens;
PageControl1.ActivePage := Tab_Pesquisa;

end;


end;



procedure TForm_Mov_Compra.FormCreate(Sender: TObject);
begin
PageControl1.ActivePage := Tab_Pesquisa;
DM.Q_produto.Close;
DM.Q_produto.Open;
dm.Q_produto.Last;
dm.Q_produto.First;

DM.Q_Fornecedor.Close;
DM.Q_Fornecedor.Open;
//gambiware
dm.Q_Fornecedor.Last;
dm.Q_Fornecedor.First;
Q_caixa.Active := true;
Q_Compra.Open;

Q_Compra_item.Open;

DateEdit1.Date := (date);
  Q_Compra.Close;
  Q_Compra.sql.clear;
  Q_Compra.sql.Add('select tab_compra.*, tab_fornecedor.nome_fornecedor');
  Q_Compra.sql.Add(' from tab_fornecedor inner join tab_compra on (tab_compra.id_fornecedor = tab_fornecedor.id_fornecedor)');
  Q_Compra.SQL.Add('where dt_compra = :p_data_filtro');
  Q_Compra.SQL.Add('order by tab_compra.id_compra');
  Q_Compra.ParamByName('p_data_filtro').AsDate := DateEdit1.Date;
  Q_Compra.Open;
end;

procedure TForm_Mov_Compra.limpa_edts_itens;
begin
edit_produto.KeyValue := Null;
Edit_quantidade.Clear;
Edit_precocusto.Clear;
end;

procedure TForm_Mov_Compra.limpa_edts_compra;
begin
Edit2.Clear;
Edit3.Text := '  /  /    ';
edit_fornecdor.KeyValue := Null;
//Edit_datavct.Text :=  '  /  /    ';
Edit_total.Clear;
end;

procedure TForm_Mov_Compra.btn_cancelarClick(Sender: TObject);
begin

limpa_edts_itens;
limpa_edts_compra;
panel_cabecalho.Enabled := False;
panel_itens.Enabled := False;
btb_finalizar.Enabled := False;
PageControl1.ActivePage := Tab_Pesquisa;
btb_finalizar.Enabled := False;
btn_cancelar.Enabled := False;
btn_incluir.Enabled := True;
btn_visualizar.Enabled := True;
btn_fechar.Enabled := True;
Tab_Conta_pagar.Cancel;
Rx_Parcela.Close;
end;

procedure TForm_Mov_Compra.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
 DM.Q_produto.Close;
DM.Q_Fornecedor.Close;
Q_Compra.Close;
Q_Compra_item.Close;
end;

procedure TForm_Mov_Compra.FormKeyPress(Sender: TObject; var Key: Char);
begin
if  key = #13 then begin
    key := #0;
    Perform(WM_NEXTDLGCTL,0,0);
    end
    Else Exit;
end;

procedure TForm_Mov_Compra.Edit_datavctExit(Sender: TObject);
begin
edit_produto.SetFocus;
end;

procedure TForm_Mov_Compra.panel_cabecalhoExit(Sender: TObject);
begin
//panel_cabecalho.Enabled := False;
end;

procedure TForm_Mov_Compra.RxMemoriaCalcFields(DataSet: TDataSet);
begin
RxMemoriasub_total.AsFloat := RxMemoriaqtde.AsFloat * RxMemoriapreco_custo.AsFloat;
end;


procedure TForm_Mov_Compra.BitBtn2Click(Sender: TObject);
begin
 RxMemoria.Open;
 RxMemoria.Insert;
 RxMemoriacod_produto.Value :=  edit_produto.KeyValue;
 RxMemoriadescricao.Value := edit_produto.Text;
 RxMemoriaqtde.Value := Edit_quantidade.Value;
 RxMemoriapreco_custo.Value := Edit_precocusto.Value;
 RxMemoria.Post;
 Calcula_Total;
 limpa_edts_itens;
 edit_produto.SetFocus;
 
end;

procedure TForm_Mov_Compra.calcula_total;
begin
  Edit_total.Value := 0;
  RxMemoria.First;
  While not RxMemoria.eof do
   begin
   Edit_total.Value := Edit_total.Value + RxMemoriasub_total.Value;
   RxMemoria.Next;
   end;
end;

procedure TForm_Mov_Compra.BitBtn3Click(Sender: TObject);
begin
  if not RxMemoria.IsEmpty then begin
    RxMemoria.Delete;
    RxMemoria.Refresh;
    calcula_total;
  end;
  DBImage1.Visible := false;
end;

procedure TForm_Mov_Compra.Edit_quantidadeExit(Sender: TObject);
begin
  if edit_produto.KeyValue = Null then begin
    ShowMessage('Escolha um Produto');
    edit_produto.SetFocus;
    Exit;
    end;

    try
    Edit_precocusto.Value := DM.Q_produtoVLCUSTO.AsFloat;
    Except
    ShowMessage('Produto não encontrado');
    edit_produto.SetFocus;
    End;

    if StrToint (Edit_quantidade.Text) < 0 then begin
      ShowMessage('Informe uma quantidade válida');
      Edit_quantidade.SetFocus;
      exit;
      end;


end;

procedure TForm_Mov_Compra.btn_visualizarClick(Sender: TObject);
begin
  RxMemoria.Close;

  Edit2.Text              := Q_CompraID_COMPRA.AsString;
  Edit3.Text              := Q_CompraDT_COMPRA.AsString;
  edit_fornecdor.KeyValue := Q_CompraID_FORNECEDOR.AsInteger;
  //Edit_datavct.Text       := Q_CompraDTVCT.AsString;
  Edit_total.Text         := Q_CompraVL_TOTAL.AsString;

  Q_Compra_item.Close;
  Q_Compra_item.sql.clear;
  Q_Compra_item.sql.Add('select tab_item_compra.*, tab_produto.nome_produto');
  Q_Compra_item.sql.Add(' from tab_produto inner join tab_item_compra on (tab_produto.id_produto =tab_item_compra.id_produto)');
  Q_Compra_item.SQL.Add('where id_compra = :p_nrcompra');
  Q_Compra_item.ParamByName('p_nrcompra').AsInteger := Q_CompraID_COMPRA.AsInteger;
  Q_Compra_item.Open;

  Q_Compra_item.First;
  while not Q_Compra_item.Eof do begin
    RxMemoria.Open;
    RxMemoria.Insert;
    RxMemoriacod_produto.Value  := Q_Compra_itemID_PRODUTO.AsInteger;
    RxMemoriadescricao.Value    := Q_Compra_itemNOME_PRODUTO.AsString;
    RxMemoriaqtde.Value         := Q_Compra_itemQUANTIDADE.AsFloat;
    RxMemoriapreco_custo.Value  := Q_Compra_itemPRECO_CUSTO.AsFloat;
    RxMemoriasub_total.Value    := Q_Compra_itemQUANTIDADE.AsFloat * Q_Compra_itemPRECO_CUSTO.AsFloat;
    RxMemoria.Post;
    Q_Compra_item.Next;
  end;
  
  calcula_total;
  panel_cabecalho.Enabled := False;
  panel_itens.Enabled     := False;
  PageControl1.ActivePage := Tab_Compra;
  btn_voltar.Enabled := True;
  btn_voltar.Font.Color := clRed;
  desabilita_botoes;
  btb_finalizar.Enabled  := False;

end;

procedure TForm_Mov_Compra.btn_voltarClick(Sender: TObject);
begin
PageControl1.ActivePage := Tab_Pesquisa;
btn_voltar.Enabled := False;
limpa_edts_itens;
limpa_edts_compra;
panel_cabecalho.Enabled := False;
panel_itens.Enabled := False;
habilita_botoes;
btb_finalizar.Enabled := True;
end;

procedure TForm_Mov_Compra.Edit1Change(Sender: TObject);
begin
  Case Rg_tipo.ItemIndex of
  0: Q_Compra.Locate('ID_compra',Edit1.Text, [loPartialKey, loCaseInsensitive]);
  end;
end;
procedure TForm_Mov_Compra.DateEdit1Exit(Sender: TObject);
begin

  Q_Compra.Close;
  Q_Compra.sql.clear;
  Q_Compra.sql.Add('select tab_compra.*, tab_fornecedor.nome_fornecedor');
  Q_Compra.sql.Add(' from tab_fornecedor inner join tab_compra on (tab_compra.id_fornecedor = tab_fornecedor.id_fornecedor)');
  Q_Compra.SQL.Add('where dt_compra = :p_data_filtro');
  Q_Compra.SQL.Add('order by tab_compra.id_compra');
  Q_Compra.ParamByName('p_data_filtro').AsDate := DateEdit1.Date;
  Q_Compra.Open;
end;

procedure TForm_Mov_Compra.BitBtn1Click(Sender: TObject);
begin

nun_parc := 0;
Rx_Parcela.First;

nun_parc := Rx_Parcelanun_parc.Value + 1;

 Rx_Parcela.Open;
 Rx_Parcela.Insert;

if CurrencyEdit1.Value = 0 then begin
 CurrencyEdit3.Value := CurrencyEdit3.Value - CurrencyEdit2.Value;
 Rx_Parcelavl_parcela.Value := CurrencyEdit2.Value;
 Rx_Parceladt_vencimento.Value := DateEdit2.Date;
 Rx_Parcelanun_parc.Value := nun_parc;
 Rx_Parcela.Post;
 CurrencyEdit2.Value := 0;
end;

if CurrencyEdit1.Value > 0 then begin
  CurrencyEdit3.Value := CurrencyEdit3.Value - CurrencyEdit1.Value;
 Rx_Parcelavl_parcela.Value := CurrencyEdit1.Value;
 DateEdit2.Date := Date;
 Rx_Parcelanun_parc.Value := nun_parc;
 Rx_Parceladt_vencimento.Value := DateEdit2.Date;
 Rx_Parcela.Post;
  CurrencyEdit1.Value := 0;
end;
 
end;

procedure TForm_Mov_Compra.BitBtn4Click(Sender: TObject);
begin
if not Rx_Parcela.IsEmpty then begin
CurrencyEdit3.Value := CurrencyEdit3.Value +  Rx_Parcelavl_parcela.Value;
    Rx_Parcela.Delete;
    Rx_Parcela.Refresh;


  end;
end;

procedure TForm_Mov_Compra.Edit4Exit(Sender: TObject);
begin
CurrencyEdit4.Value := CurrencyEdit3.Value / StrToInt(Edit4.Text);
end;

procedure TForm_Mov_Compra.BitBtn5Click(Sender: TObject);
var nr_parc : integer;
begin
Rx_Parcela.First;

nun_parc := Rx_Parcelanun_parc.Value + 1;

if CurrencyEdit5.Value > 0 then begin
Rx_Parcela.Open;
Rx_Parcela.Insert;
Rx_Parcelavl_parcela.Value := CurrencyEdit5.Value;
Rx_Parceladt_vencimento.Value := Date;
//nun_parc := 1;
Rx_Parcelanun_parc.Value := nun_parc;
Rx_Parcela.Post;

CurrencyEdit3.Value := CurrencyEdit3.Value - CurrencyEdit5.Value;
CurrencyEdit5.Value := 0;
end;

if CurrencyEdit4.Value > 0 then begin
Rx_Parcela.First;

nun_parc := Rx_Parcelanun_parc.Value + 1;
  DateEdit2.Date := Date;
  nr_parc := StrToInt(Edit4.Text);
  while nr_parc >0 do begin

    Rx_Parcela.Open;
    Rx_Parcela.Insert;
    Rx_Parcelavl_parcela.Value := CurrencyEdit4.Value;
    DateEdit2.Date := DateEdit2.Date + 31;
    Rx_Parceladt_vencimento.Value := DateEdit2.Date;

    Rx_Parcelanun_parc.Value := nun_parc;
    Rx_Parcela.Post;
    Inc(nun_parc);
    Dec(nr_parc);
    CurrencyEdit3.Value := CurrencyEdit3.Value - CurrencyEdit4.Value;
  end;
   end;
Edit4.Text := ' ';
CurrencyEdit4.Value := 0;
end;
procedure TForm_Mov_Compra.BitBtn6Click(Sender: TObject);
begin
if not Rx_Parcela.IsEmpty then begin
CurrencyEdit3.Value := CurrencyEdit3.Value +  Rx_Parcelavl_parcela.Value;
    Rx_Parcela.Delete;
    Rx_Parcela.Refresh;


  end;
end;

procedure TForm_Mov_Compra.TabSheet1Enter(Sender: TObject);
begin
i := 3;
end;

procedure TForm_Mov_Compra.RadioGroup1Click(Sender: TObject);
begin
case RadioGroup1.ItemIndex of
0 :  i := 0;
1 : i := 1;
end;
end;

procedure TForm_Mov_Compra.edit_produtoExit(Sender: TObject);
begin
DBImage1.Visible := True;
end;

procedure TForm_Mov_Compra.DBGrid2CellClick(Column: TColumn);
begin
//dm.Q_produto.Locate(),Edit1.Text, [loPartialKey, loCaseInsensitive]);
end;

procedure TForm_Mov_Compra.Button1Click(Sender: TObject);
begin
  Q_Compra.Close;
  Q_Compra.sql.clear;
  Q_Compra.sql.Add('select tab_compra.*, tab_fornecedor.nome_fornecedor');
  Q_Compra.sql.Add(' from tab_fornecedor inner join tab_compra on (tab_compra.id_fornecedor = tab_fornecedor.id_fornecedor)');
  //Q_Compra.SQL.Add('where dt_compra = :p_data_filtro');
  Q_Compra.SQL.Add('order by tab_compra.id_compra');
 // Q_Compra.ParamByName('p_data_filtro').AsDate := DateEdit1.Date;
  Q_Compra.Open;
end;

end.
