unit Unit_Descarte;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, Buttons, ExtCtrls, Grids, DBGrids, ComCtrls, DB,
  IBCustomDataSet, Mask, DBCtrls, IBQuery, IBSQL, IBDatabase;

type
  TForm_Descarte = class(TForm)
    Panel1: TPanel;
    PageControl1: TPageControl;
    Tab_Pesquisa: TTabSheet;
    Tab_Cadastro: TTabSheet;
    DBGrid1: TDBGrid;
    Rg_tipo: TRadioGroup;
    GroupBox1: TGroupBox;
    Edit1: TEdit;
    btn_incluir: TBitBtn;
    btn_alterar: TBitBtn;
    btn_excluir: TBitBtn;
    btn_fechar: TBitBtn;
    btn_comfirmar: TBitBtn;
    btn_cancelar: TBitBtn;
    Ds_Cidade: TDataSource;
    Tab_Cidade: TIBDataSet;
    DBEdit5: TDBLookupComboBox;
    Tab_CidadeID_DESCARTE: TIntegerField;
    Tab_CidadeMOTIVO_DESCARTE: TIBStringField;
    Tab_CidadeVL_DESCARTE: TFloatField;
    Tab_CidadeQUANTIDADE: TIntegerField;
    Tab_CidadeID_PRODUTO: TIntegerField;
    Label1: TLabel;
    DBEdit1: TDBEdit;
    Label2: TLabel;
    DBEdit2: TDBEdit;
    Label3: TLabel;
    DBEdit3: TDBEdit;
    Label4: TLabel;
    DBEdit4: TDBEdit;
    Label5: TLabel;
    DBImage1: TDBImage;
    RadioGroup1: TRadioGroup;
    TExecutaSql: TIBTransaction;
    ExecutaSql: TIBSQL;
    Q_caixa: TIBQuery;
    Q_caixaID_CAIXA: TIntegerField;
    Q_caixaVL_INICIAL: TFloatField;
    Q_caixaDT_INICIAL: TDateField;
    Q_caixaVL_FECHA: TFloatField;
    Q_caixaDT_FECHA: TDateField;
    procedure btn_fecharClick(Sender: TObject);
    procedure habilita_botoes;
    procedure desabilita_botoes;
    procedure btn_incluirClick(Sender: TObject);
    procedure btn_alterarClick(Sender: TObject);
    procedure btn_cancelarClick(Sender: TObject);
    procedure btn_comfirmarClick(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure PageControl1Changing(Sender: TObject;
      var AllowChange: Boolean);
    procedure btn_excluirClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure Edit1Change(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure DBEdit5Exit(Sender: TObject);
    procedure DBEdit5Enter(Sender: TObject);
    procedure RadioGroup1Exit(Sender: TObject);
    procedure DBEdit4Exit(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form_Descarte: TForm_Descarte;
  i : integer;
implementation

uses Unit_DM;

{$R *.dfm}

procedure TForm_Descarte.btn_fecharClick(Sender: TObject);
begin
Close;
Tab_Cidade.Close;
Tab_Cidade.Open;
end;

procedure TForm_Descarte.Habilita_botoes;
begin
 btn_incluir.enabled := True;
 btn_alterar.enabled := True;
 btn_excluir.enabled := True;
 btn_fechar.enabled := True;
end;

procedure TForm_Descarte.Desabilita_botoes;
begin
 btn_incluir.enabled := False;
 btn_alterar.enabled := False;
 btn_excluir.enabled := False;
 btn_fechar.enabled := False;
end;
procedure TForm_Descarte.btn_incluirClick(Sender: TObject);
begin
DBImage1.Visible := false;
desabilita_botoes;
PageControl1.ActivePage := Tab_Cadastro;
Tab_Cidade.Insert;
DBEdit4.Text :='0';
end;

procedure TForm_Descarte.btn_alterarClick(Sender: TObject);
begin
desabilita_botoes;
PageControl1.ActivePage := Tab_Cadastro;
Tab_Cidade.Edit;
end;

procedure TForm_Descarte.btn_cancelarClick(Sender: TObject);
begin
habilita_botoes;
PageControl1.ActivePage := Tab_Pesquisa;
Tab_Cidade.Cancel;
end;

procedure TForm_Descarte.btn_comfirmarClick(Sender: TObject);
begin
Try
if i = 0 then begin
TExecutaSql.StartTransaction;
Q_caixa.First;
    while NOT Q_caixa.Eof do begin
      if Q_caixaVL_FECHA.Value = 0 then begin
      ExecutaSql.Close;
      ExecutaSql.SQL.Clear;
      ExecutaSql.SQL.Add('insert into TAB_item_CAIXA(num_lanc,ID_CAIXA,TIPO_LANC,VL_LANC,HISTORICO)');
      ExecutaSql.SQL.Add('values (gen_id(GEN_TAB_ITEM_CAIXA_ID,1),:p_id_caixa,:p_TIPO_LANC, :p_VL_LANC, :p_HISTORICO)');
      ExecutaSql.ParamByName('p_id_caixa').AsInteger := Q_caixaID_CAIXA.AsInteger;
      ExecutaSql.ParamByName('p_TIPO_LANC').AsString := 'D';
      ExecutaSql.ParamByName('p_VL_LANC').AsCurrency := StrToFloat(DBEdit3.Text);
      ExecutaSql.ParamByName('p_HISTORICO').AsString := 'GERADO PELO MOVIMENTO DE DEVOLUÇÃO DE CLIENTE!!!';
      ExecutaSql.ExecQuery;
      end;
    Q_caixa.Next;
    end;

     ExecutaSql.Close;
      ExecutaSql.SQL.Clear;
      ExecutaSql.SQL.Add('update tab_produto set qtdestoque = qtdestoque + :p_quantidade where nome_produto = :p_id_produto');
      ExecutaSql.ParamByName('p_quantidade').AsFloat  := StrToFloat(DBEdit4.Text);
      ExecutaSql.ParamByName('p_id_produto').AsVariant := DBEdit5.Text;
      ExecutaSql.ExecQuery;


end;

if i = 1 then begin
TExecutaSql.StartTransaction;
Q_caixa.First;
    while NOT Q_caixa.Eof do begin
      if Q_caixaVL_FECHA.Value = 0 then begin
      ExecutaSql.Close;
      ExecutaSql.SQL.Clear;
      ExecutaSql.SQL.Add('insert into TAB_item_CAIXA(num_lanc,ID_CAIXA,TIPO_LANC,VL_LANC,HISTORICO)');
      ExecutaSql.SQL.Add('values (gen_id(GEN_TAB_ITEM_CAIXA_ID,1),:p_id_caixa,:p_TIPO_LANC, :p_VL_LANC, :p_HISTORICO)');
      ExecutaSql.ParamByName('p_id_caixa').AsInteger := Q_caixaID_CAIXA.AsInteger;
      ExecutaSql.ParamByName('p_TIPO_LANC').AsString := 'C';
      ExecutaSql.ParamByName('p_VL_LANC').AsCurrency := StrToFloat(DBEdit3.Text);
      ExecutaSql.ParamByName('p_HISTORICO').AsString := 'GERADO PELO MOVIMENTO DE DEVOLUÇÃO PARA FORNECEDOR';
      ExecutaSql.ExecQuery;
      end;
    Q_caixa.Next;
    end;

     ExecutaSql.Close;
      ExecutaSql.SQL.Clear;
      ExecutaSql.SQL.Add('update tab_produto set qtdestoque = qtdestoque - :p_quantidade where nome_produto = :p_id_produto');
      ExecutaSql.ParamByName('p_quantidade').AsFloat  := StrToFloat(DBEdit4.Text);
      ExecutaSql.ParamByName('p_id_produto').AsVariant := DBEdit5.Text;
      ExecutaSql.ExecQuery;

end;

if i = 2 then begin
TExecutaSql.StartTransaction;
 ExecutaSql.Close;
      ExecutaSql.SQL.Clear;
      ExecutaSql.SQL.Add('update tab_produto set qtdestoque = qtdestoque - :p_quantidade where nome_produto = :p_id_produto');
      ExecutaSql.ParamByName('p_quantidade').AsFloat  := StrToFloat(DBEdit4.Text);
      ExecutaSql.ParamByName('p_id_produto').AsVariant := DBEdit5.Text;
      ExecutaSql.ExecQuery;
end;


   TExecutaSql.Commit;
    Tab_Cidade.Post;
    DM.TBanco.CommitRetaining;
    Tab_Cidade.Close;
    Tab_Cidade.Open;
    ShowMessage('O registro foi gravado com sucesso!');
  Except
   TExecutaSql.Rollback;
   ShowMessage('Erro. Não foi possivel Devolução!');
   DM.TBanco.Rollback;
   ShowMessage('Não foi possivel gravar dados!');
  Raise;
  end;

habilita_botoes;
PageControl1.ActivePage := Tab_Pesquisa;
end;

procedure TForm_Descarte.FormActivate(Sender: TObject);
begin
PageControl1.ActivePage := Tab_Pesquisa;
end;

procedure TForm_Descarte.PageControl1Changing(Sender: TObject;
  var AllowChange: Boolean);
begin
AllowChange:= False;
end;

procedure TForm_Descarte.btn_excluirClick(Sender: TObject);
begin
  if Application.MessageBox('Deseja Excluir a Cidade selecionada ?','SOF CONTROL', MB_yesno + MB_Iconquestion) = Id_YES then begin
   Tab_Cidade.Delete;
  end;
end;
procedure TForm_Descarte.FormCreate(Sender: TObject);
begin
DBImage1.Visible := false;
tab_cidade.Active := true;
Tab_Cidade.Open;
dm.Q_produto.Active := true;
dm.Q_produto.cLOSE;
dm.Q_produto.Open;
dm.Q_produto.Last;
dm.Q_produto.First;


Q_caixa.Active:= true;
Q_caixa.Close;
Q_caixa.Open;
TExecutaSql.Active := true;
end;

procedure TForm_Descarte.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
Try
Tab_Cidade.Close;
Except
ShowMessage('NÃO foi possivel fechar tabela Fornecedor!');
Raise;
end;
 end;
procedure TForm_Descarte.Edit1Change(Sender: TObject);
begin
Case  Rg_tipo.ItemIndex of
0: Tab_Cidade.Locate('id_descarte', Edit1.Text, [ loPartialKey, loCaseInsensitive]);
1: Tab_Cidade.Locate('motivo_descarte', Edit1.Text, [ loPartialKey, loCaseInsensitive]);
end;
end;
procedure TForm_Descarte.FormKeyPress(Sender: TObject; var Key: Char);
begin
if  key = #13 then begin
    key := #0;
    Perform(WM_NEXTDLGCTL,0,0);
    end
    Else Exit;
end;

procedure TForm_Descarte.DBEdit5Exit(Sender: TObject);
begin
DBImage1.Visible := True;
end;

procedure TForm_Descarte.DBEdit5Enter(Sender: TObject);
begin
DBImage1.Visible := false;
end;

procedure TForm_Descarte.RadioGroup1Exit(Sender: TObject);
var prec :integer;
begin
case RadioGroup1.ItemIndex of
0: i := 0;
1: i := 1;
2: i := 2;
end;
case i of
0: prec := dm.Q_produtoVLVENDA.AsInteger * StrToInt(DBEdit4.Text);
1: prec := dm.Q_produtoVLCUSTO.AsInteger * StrToInt(DBEdit4.Text);
2: prec := 0;
end;
DBEdit3.Text := IntToStr(prec);


end;
procedure TForm_Descarte.DBEdit4Exit(Sender: TObject);
var prec :Currency;
begin
case i of
0: prec := dm.Q_produtoVLVENDA.AsCurrency * StrToCurr(DBEdit4.Text);
1: prec := dm.Q_produtoVLCUSTO.AsCurrency * StrToCurr(DBEdit4.Text);
2: prec := 0;
end;
DBEdit3.Text := CurrToStr(prec);
end;

end.
