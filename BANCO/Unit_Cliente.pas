 unit Unit_Cliente;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, Buttons, ExtCtrls, Grids, DBGrids, ComCtrls, DB,
  IBCustomDataSet, Mask, DBCtrls, RxGIF, ToolEdit;

type
  TForm_Cliente = class(TForm)
    PageControl1: TPageControl;
    Tab_Pesquisa: TTabSheet;
    Tab_Cadastro: TTabSheet;
    Rg_tipo: TRadioGroup;
    GroupBox1: TGroupBox;
    Edit1: TEdit;
    btn_comfirmar: TBitBtn;
    btn_cancelar: TBitBtn;
    Ds_Cliente: TDataSource;
    DBGrid2: TDBGrid;
    Tab_Cliente: TIBDataSet;
    Label1: TLabel;
    DBEdit1: TDBEdit;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    DBEdit4: TDBEdit;
    Label5: TLabel;
    DBEdit5: TDBEdit;
    Label6: TLabel;
    DBEdit6: TDBEdit;
    Label7: TLabel;
    DBEdit7: TDBEdit;
    Label8: TLabel;
    DBEdit8: TDBEdit;
    Label9: TLabel;
    DBEdit9: TDBEdit;
    Label16: TLabel;
    Label17: TLabel;
    DBEdit17: TDBEdit;
    Label18: TLabel;
    DBEdit18: TDBEdit;
    Label19: TLabel;
    Tab_ClienteID_CLIENTE: TIntegerField;
    Tab_ClienteID_CIDADE: TIntegerField;
    Tab_ClienteID_ESTADO: TIntegerField;
    Tab_ClienteNOME_CLIENTE: TIBStringField;
    Tab_ClienteENDERECO_CLIENTE: TIBStringField;
    Tab_ClienteBAIRRO_CLIENTE: TIBStringField;
    Tab_ClienteCEP_CLIENTE: TIBStringField;
    Tab_ClienteTELEFONE1_CLIENTE: TIBStringField;
    Tab_ClienteTELEFONE2_CLIENTE: TIBStringField;
    Tab_ClienteRG_CLIENTE: TIBStringField;
    Tab_ClienteINSC_ESTADUAL: TIBStringField;
    Tab_ClienteCNPJ_CLIENTE: TIBStringField;
    Tab_ClientePESSOA: TIBStringField;
    Tab_ClienteSEXO_CLIENTE: TIBStringField;
    Tab_ClienteEMAIL_CLIENTE: TIBStringField;
    Tab_ClienteDTCADASTRO_CLIENTE: TDateField;
    Tab_ClienteDTNASC_CLIENTE: TDateField;
    Tab_ClienteCPF_CLIENTE: TIBStringField;
    Label15: TLabel;
    DBEdit15: TDBEdit;
    RadioGroup1: TRadioGroup;
    RadioGroup2: TRadioGroup;
    PageControl2: TPageControl;
    TabSheet1: TTabSheet;
    TabSheet2: TTabSheet;
    Label10: TLabel;
    DBEdit10: TDBEdit;
    Label20: TLabel;
    DBEdit20: TDBEdit;
    Label11: TLabel;
    DBEdit11: TDBEdit;
    Label12: TLabel;
    DBEdit12: TDBEdit;
    Image1: TImage;
    Image2: TImage;
    DBEdit2: TDBLookupComboBox;
    DBEdit3: TDBLookupComboBox;
    Image3: TImage;
    Image4: TImage;
    DBEdit19: TDateEdit;
    DBEdit13: TDateEdit;
    btn_fechar: TBitBtn;
    btn_excluir: TBitBtn;
    btn_alterar: TBitBtn;
    btn_incluir: TBitBtn;
    procedure btn_fecharClick(Sender: TObject);
    procedure habilita_botoes;
    procedure desabilita_botoes;
    procedure btn_incluirClick(Sender: TObject);
    procedure btn_alterarClick(Sender: TObject);
    procedure btn_cancelarClick(Sender: TObject);
    procedure btn_comfirmarClick(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure PageControl1Changing(Sender: TObject;
      var AllowChange: Boolean);
    procedure btn_excluirClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure Trava_campos;
    procedure Destrava_campos;
    procedure DBEdit2Exit(Sender: TObject);
    procedure Edit1Change(Sender: TObject);
    procedure RadioGroup1Click(Sender: TObject);
    procedure RadioGroup2Click(Sender: TObject);
    procedure RadioGroup1Exit(Sender: TObject);
    procedure DBEdit20Exit(Sender: TObject);
    procedure DBEdit12Exit(Sender: TObject);



  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form_Cliente: TForm_Cliente;

implementation

uses Unit_DM, UnitMenu;

{$R *.dfm}

procedure TForm_Cliente.btn_fecharClick(Sender: TObject);
begin
Close;
end;




procedure TForm_Cliente.Habilita_botoes;
begin
 btn_incluir.enabled := True;
 btn_alterar.enabled := True;
 btn_excluir.enabled := True;
 btn_fechar.enabled := True;

end;

procedure TForm_Cliente.Trava_campos;
begin

DBEdit3.Enabled := False;
DBEdit4.Enabled := False;

DBEdit6.Enabled:= False;
DBEdit8.Enabled := False;
DBEdit2.Enabled := False;
DBEdit7.Enabled := False;
DBEdit5.Enabled := False;


end;
procedure TForm_Cliente.Destrava_campos;
begin

DBEdit3.Enabled := True;
DBEdit4.Enabled := True;
DBEdit6.Enabled:= True;
DBEdit8.Enabled := True;
DBEdit2.Enabled := True;
DBEdit7.Enabled := TRue;
DBEdit5.Enabled := True;

end;



procedure TForm_Cliente.Desabilita_botoes;
begin
 btn_incluir.enabled := False;
 btn_alterar.enabled := False;
 btn_excluir.enabled := False;
 btn_fechar.enabled := False;
end;
procedure TForm_Cliente.btn_incluirClick(Sender: TObject);
begin
desabilita_botoes;
PageControl1.ActivePage := Tab_Cadastro;
Tab_Cliente.Insert;
btn_comfirmar.Enabled := True;
Image1.Visible := False;
Image2.Visible := False;
Image3.Visible := False;
Image4.Visible := False;
DBEdit13.Date := date;
DBEdit19.Clear;

RadioGroup1.ItemIndex := -1;
RadioGroup2.ItemIndex := -1;
end;

procedure TForm_Cliente.btn_alterarClick(Sender: TObject);
begin
desabilita_botoes;
PageControl1.ActivePage := Tab_Cadastro;
 Tab_Cliente.Edit;
 Image1.Transparent := True;
 Image2.Visible := False;
 Image4.Transparent := True;
 Image3.Visible := False;

 DBEdit13.Date := Tab_ClienteDTCADASTRO_CLIENTE.Value;
 DBEdit19.Date := Tab_ClienteDTNASC_CLIENTE.Value;

if Tab_ClientePESSOA.Text = 'FISICA' then begin
RadioGroup1.ItemIndex := 0;
PageControl2.ActivePage := TabSheet1;
end;
if Tab_ClientePESSOA.Text = 'JURIDICA' then begin
RadioGroup1.ItemIndex := 1;
PageControl2.ActivePage := TabSheet2;
end;
if Tab_ClienteSEXO_CLIENTE.Text = 'FEMENINO' then begin
RadioGroup2.ItemIndex := 0;
end;
if Tab_ClienteSEXO_CLIENTE.Text = 'MASCULINO' then begin
RadioGroup2.ItemIndex := 1;
end;

end;

procedure TForm_Cliente.btn_cancelarClick(Sender: TObject);
begin
habilita_botoes;
PageControl1.ActivePage := Tab_Pesquisa;
Tab_Cliente.Cancel;
Destrava_campos;
end;

procedure TForm_Cliente.btn_comfirmarClick(Sender: TObject);
begin
Tab_ClienteDTNASC_CLIENTE.Value := DBEdit19.Date;
Tab_ClienteDTCADASTRO_CLIENTE.Value := DBEdit13.Date;

if DBEdit2.Text = '' then begin
    ShowMessage('Digite um nome de Cidade Válido!');
    DBEdit2.SetFocus;
    end;
if DBEdit3.Text = '' then begin
    ShowMessage('Digite um nome de Estado Válido!');
    DBEdit3.SetFocus;
    end;
if DBEdit4.Text = '' then begin
    ShowMessage('Digite um nome do Cliente Válido!');
    DBEdit4.SetFocus;
    end;
if DBEdit5.Text = '' then begin
    ShowMessage('Digite um Endereço Válido!');
    DBEdit5.SetFocus;
    end;

if (DBEdit2.Text > '') and (DBEdit3.Text > '') and(DBEdit4.Text > '') and(DBEdit5.Text > '') and(DBEdit7.Text > '') and(DBEdit13.Text > '') and (DBEdit19.Text > '') then begin
  Try
    Tab_Cliente.Post;
    DM.TBanco.CommitRetaining;
    ShowMessage('O registro foi gravado com sucesso!');
    Tab_Cliente.Close;
    Tab_Cliente.Open;

  Except
   //DM.TBanco.Rollback;
   ShowMessage('Não foi possivel gravar dados!');
  Raise;
  end;
habilita_botoes;
PageControl1.ActivePage := Tab_Pesquisa;
end;
end;
procedure TForm_Cliente.FormActivate(Sender: TObject);
begin
PageControl1.ActivePage := Tab_Pesquisa;
end;

procedure TForm_Cliente.PageControl1Changing(Sender: TObject;
  var AllowChange: Boolean);
begin
AllowChange:= False;
end;

procedure TForm_Cliente.btn_excluirClick(Sender: TObject);
begin
if Application.MessageBox('Deseja Excluir o Cliente selecionado ?','SOF CONTROL', MB_yesno + MB_Iconquestion) = Id_YES then begin
   Tab_Cliente.Delete;
  end;


end;

procedure TForm_Cliente.FormCreate(Sender: TObject);
begin
DM.Q_Cidade.Close;
DM.Q_Cidade.Open;
dm.Q_Cidade.Last;
dm.Q_Cidade.First;

DM.Q_Estado.cLOSE;
DM.Q_Estado.Open;
dm.Q_Estado.Last;
dm.Q_Estado.First;

Tab_Cliente.Active := true;
Tab_Cliente.Open;

end;

procedure TForm_Cliente.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
Try
DM.Q_Cidade.Open;
DM.Q_Estado.Open;
Tab_Cliente.Close;
Except
ShowMessage('NÃO foi possivel fechar tabela Tab_Cliente!');
Raise;
end;
 end;
function Cpf(CPF_Text: string): boolean;
var n1,n2,n3,n4,n5,n6,n7,n8,n9: integer;
       d1,d2: integer;
       digitado, calculado: string;
begin
   n1:=StrToInt(CPF_Text[1]);
   n2:=StrToInt(CPF_Text[2]);
   n3:=StrToInt(CPF_Text[3]);
   n4:=StrToInt(CPF_Text[5]);
   n5:=StrToInt(CPF_Text[6]);
   n6:=StrToInt(CPF_Text[7]);
   n7:=StrToInt(CPF_Text[9]);
   n8:=StrToInt(CPF_Text[10]);
   n9:=StrToInt(CPF_Text[11]);
                     d1:=n9*2+n8*3+n7*4+n6*5+n5*6+n4*7+n3*8+n2*9+n1*10;
  d1:=11-(d1 mod 11);
   if d1>=10 then d1:=0;
        d2:=d1*2+n9*3+n8*4+n7*5+n6*6+n5*7+n4*8+n3*9+n2*10+n1*11;
    d2:=11-(d2 mod 11);
    if d2>=10 then
       d2:=0;
    calculado:=inttostr(d1)+inttostr(d2);
   digitado:=CPF_Text[13]+CPF_Text[14];
   if calculado=digitado then
       Cpf:=true
   else
       Cpf:=false;
end;

procedure TForm_Cliente.DBEdit2Exit(Sender: TObject);
begin
 if DBEdit2.Text > ''then begin

     If Cpf(DBEdit2.Text)=False Then
    Begin
      Image2.Transparent := True;
      Image2.Visible := True;
      Image1.Visible := False;
      MessageDlg('CPF informado é inválido!',mtError, [mbOk],0);
      DBEdit2.SetFocus;
    End;
    If Cpf(DBEdit2.Text)=True Then
    Begin
      Image2.Visible := False;
      Image1.Transparent := True;
      Image1.Visible := True;
    End;

end;
end;

procedure TForm_Cliente.Edit1Change(Sender: TObject);
begin
Case  Rg_tipo.ItemIndex of
0: Tab_Cliente.Locate('id_cliente', Edit1.Text, [ loPartialKey, loCaseInsensitive]);
1: Tab_Cliente.Locate('nome_cliente', Edit1.Text, [ loPartialKey, loCaseInsensitive]);
end;
end;

procedure TForm_Cliente.RadioGroup1Click(Sender: TObject);
begin
case RadioGroup1.ItemIndex of
0: PageControl2.ActivePage := TabSheet1;
1: PageControl2.ActivePage := TabSheet2;


end;
end;
procedure TForm_Cliente.RadioGroup2Click(Sender: TObject);
begin
case RadioGroup2.ItemIndex of
0: Tab_ClienteSEXO_CLIENTE.Text:= 'FEMENINO';
1: Tab_ClienteSEXO_CLIENTE.Text:= 'MASCULINO';
end;
end;
procedure TForm_Cliente.RadioGroup1Exit(Sender: TObject);
begin
case RadioGroup1.ItemIndex of
0: Tab_ClientePESSOA.Text := 'FISICA';
1: Tab_ClientePESSOA.Text  := 'JURIDICA';
end;
end;

function Cnpj(xCNPJ: String):Boolean;
Var
  d1,d4,xx,nCount,fator,resto,digito1,digito2 : Integer;
   Check : String;
begin
d1 := 0;
d4 := 0;
xx := 1;
for nCount := 1 to Length( xCNPJ )-2 do
    begin
    if Pos( Copy( xCNPJ, nCount, 1 ), '/-.' ) = 0 then
    begin
    if xx < 5 then
    begin
    fator := 6 - xx;
    end
    else
   begin
   fator := 14 - xx;
   end;
   d1 := d1 + StrToInt( Copy( xCNPJ, nCount, 1 ) ) * fator;
   if xx < 6 then
    begin
    fator := 7 - xx;
   end
   else
   begin
   fator := 15 - xx;    end;
   d4 := d4 + StrToInt( Copy( xCNPJ, nCount, 1 ) ) * fator;
   xx := xx+1;
   end;
   end;
   resto := (d1 mod 11);
   if resto < 2 then
   begin
   digito1 := 0;
   end
   else
   begin
   digito1 := 11 - resto;
   end;
   d4 := d4 + 2 * digito1;
   resto := (d4 mod 11);
   if resto < 2 then
    begin
    digito2 := 0;
   end
   else
    begin
    digito2 := 11 - resto;
   end;
    Check := IntToStr(Digito1) + IntToStr(Digito2);
   if Check <> copy(xCNPJ,succ(length(xCNPJ)-2),2) then
    begin
    Result := False;
   end
   else
    begin
    Result := True;
   end;
end;

procedure TForm_Cliente.DBEdit20Exit(Sender: TObject);
begin
 if DBEdit20.Text > ''then begin

     If Cpf(DBEdit20.Text)=False Then
    Begin
      Image2.Transparent := True;
      Image2.Visible := True;
      Image1.Visible := False;
      MessageDlg('CPF informado é inválido!',mtError, [mbOk],0);
      DBEdit20.SetFocus;
    End;
    If Cpf(DBEdit20.Text)=True Then
    Begin
      Image2.Visible := False;
      Image1.Transparent := True;
      Image1.Visible := True;
    End;

end;
end;



procedure TForm_Cliente.DBEdit12Exit(Sender: TObject);
begin
If DBEdit12.Text<>'' Then
    If Cnpj(DBEdit12.Text)=False Then
    Begin
      Image3.Transparent := true;
      Image3.Visible := True;
      Image4.Visible := False;
      MessageDlg('CNPJ informado é inválido!',mtError, [mbOk],0);
      DBEdit8.SetFocus;
    End;
    If Cnpj(DBEdit12.Text)=True Then
    Begin
     Image3.Visible:= False;
     Image4.Visible := True;
    End;
end;

end.
