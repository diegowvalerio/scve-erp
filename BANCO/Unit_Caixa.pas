unit Unit_Caixa;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, Buttons, ExtCtrls, Grids, DBGrids, ComCtrls, DB,
  IBCustomDataSet, Mask, DBCtrls, RxGIF, IBQuery, ToolEdit, CurrEdit,
  IBDatabase, IBSQL, IBStoredProc, acPNG, RXDBCtrl;

type
  TForm_Caixa = class(TForm)
    PageControl1: TPageControl;
    Tab_Pesquisa: TTabSheet;
    Tab_Cadastro: TTabSheet;
    Rg_tipo: TRadioGroup;
    GroupBox1: TGroupBox;
    Edit1: TEdit;
    btn_comfirmar: TBitBtn;
    btn_cancelar: TBitBtn;
    Ds_Cliente: TDataSource;
    SpeedButton1: TSpeedButton;
    DBGrid2: TDBGrid;
    Tab_Cliente: TIBDataSet;
    Panel2: TPanel;
    Panel3: TPanel;
    DBGrid1: TDBGrid;
    DataSource1: TDataSource;
    TabSheet1: TTabSheet;
    ExecutaSql1: TIBSQL;
    TExecutaSql1: TIBTransaction;
    BitBtn1: TBitBtn;
    BitBtn2: TBitBtn;
    CurrencyEdit1: TCurrencyEdit;
    CurrencyEdit2: TCurrencyEdit;
    CurrencyEdit3: TCurrencyEdit;
    Label7: TLabel;
    DBComboBox1: TDBComboBox;
    Tab_ClienteID_CAIXA: TIntegerField;
    Tab_ClienteVL_INICIAL: TFloatField;
    Tab_ClienteDT_INICIAL: TDateField;
    Tab_ClienteVL_FECHA: TFloatField;
    Tab_ClienteDT_FECHA: TDateField;
    Label1: TLabel;
    DBEdit1: TDBEdit;
    Label2: TLabel;
    DBEdit2: TDBEdit;
    Label3: TLabel;
    DBEdit3: TDBEdit;
    Label4: TLabel;
    DBEdit4: TDBEdit;
    Label5: TLabel;
    Label6: TLabel;
    DBEdit8: TDBEdit;
    Label8: TLabel;
    DBEdit9: TDBEdit;
    Label9: TLabel;
    DBEdit11: TDBEdit;
    Label10: TLabel;
    DBEdit12: TDBEdit;
    Q_mov: TIBQuery;
    Q_movNUM_LANC: TIntegerField;
    Q_movID_CAIXA: TIntegerField;
    Q_movTIPO_LANC: TIBStringField;
    Q_movVL_LANC: TFloatField;
    Q_movHISTORICO: TIBStringField;
    Q_movID_CAIXA1: TIntegerField;
    SP_Compra: TIBStoredProc;
    btn_incluir: TBitBtn;
    btn_alterar: TBitBtn;
    Button1: TBitBtn;
    btn_excluir: TBitBtn;
    btn_fechar: TBitBtn;
    Image1: TImage;
    Image2: TImage;
    BitBtn3: TBitBtn;
    DBEdit5: TDBDateEdit;
    procedure btn_fecharClick(Sender: TObject);
    procedure habilita_botoes;
    procedure desabilita_botoes;
    procedure btn_incluirClick(Sender: TObject);
    procedure btn_alterarClick(Sender: TObject);
    procedure btn_cancelarClick(Sender: TObject);
    procedure btn_comfirmarClick(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure PageControl1Changing(Sender: TObject;
      var AllowChange: Boolean);
    procedure btn_excluirClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure Button1Click(Sender: TObject);
    procedure Trava_campos;
    procedure Destrava_campos;
    procedure Edit1Change(Sender: TObject);
    procedure Edit_quantidadeExit(Sender: TObject);
    procedure TabSheet1Enter(Sender: TObject);
    procedure BitBtn1Click(Sender: TObject);
    procedure BitBtn2Click(Sender: TObject);
    procedure DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure BitBtn3Click(Sender: TObject);



  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  o : integer;
  I: Integer;
  Form_Caixa: TForm_Caixa;
  inc ,al : integer;
implementation

uses RTLConsts, Unit_DM, UnitMenu;

{$R *.dfm}

procedure TForm_Caixa.btn_fecharClick(Sender: TObject);
begin
Close;
dm.Q_Caixa.Close;
dm.Q_Caixa.Open;
o := 0;
if form_menu.DateEdit1.Date = (date)then begin
  dm.Q_Caixa.First;
  while NOT dm.Q_caixa.Eof do begin
    if dm.Q_CaixaDT_INICIAL.Value = (date) then begin
    o := 1;
      form_menu.Button1.Visible := FALSE;
    end;

    dm.Q_caixa.Next;
end;
end;

if o = 0 then begin
form_menu.Button1.Visible := tRUE;
end;

end;




procedure TForm_Caixa.Habilita_botoes;
begin
 btn_incluir.enabled := True;
 btn_alterar.enabled := True;
 btn_excluir.enabled := True;
 btn_fechar.enabled := True;

end;

procedure TForm_Caixa.Trava_campos;
begin
DBEdit3.Enabled := False;
DBEdit4.Enabled := False;
DBEdit2.Enabled := False;
DBEdit5.Enabled := False;

end;
procedure TForm_Caixa.Destrava_campos;
begin

DBEdit3.Enabled := True;
DBEdit4.Enabled := True;
DBEdit2.Enabled := True;
DBEdit5.Enabled := True;
end;



procedure TForm_Caixa.Desabilita_botoes;
begin
 btn_incluir.enabled := False;
 btn_alterar.enabled := False;
 btn_excluir.enabled := False;
 btn_fechar.enabled := False;
end;
procedure TForm_Caixa.btn_incluirClick(Sender: TObject);
begin
desabilita_botoes;
PageControl1.ActivePage := Tab_Cadastro;
Tab_Cliente.Insert;
DBEdit4.Enabled := False;
DBEdit5.Enabled := False;
DBEdit3.Enabled := False ;
BitBtn3.Enabled := False;
 Q_mov.Close;
 Q_mov.sql.Clear;
 Q_mov.SQL.Add('select TAB_ITEM_CAIXA.*, Tab_caixa.id_caixa from tab_caixa');
 Q_mov.SQL.Add('inner join tab_item_caixa on(tab_item_caixa.id_caixa = tab_caixa.id_caixa)');
 Q_mov.SQL.Add('where tab_item_caixa.id_caixa = :p_nrcaixa');
 Q_mov.ParamByName('p_nrcaixa').AsInteger := Tab_ClienteID_CAIXA.AsInteger;
 Q_mov.Open;

 Q_mov.First;
while not Q_mov.eof do begin
    if Q_movTIPO_LANC.Text = 'C' then begin
    CurrencyEdit1.Value := CurrencyEdit1.Value + Q_movVL_LANC.Value;
    end;

    if Q_movTIPO_LANC.Text = 'D' then begin
     CurrencyEdit2.Value := CurrencyEdit2.Value + Q_movVL_LANC.Value;
    end;

Q_mov.Next;
end;
 CurrencyEdit3.Value := CurrencyEdit1.Value - CurrencyEdit2.Value;

btn_comfirmar.Enabled := True;
Button1.Enabled := False;
 DBEdit3.Text := DateToStr(date);
 
end;

procedure TForm_Caixa.btn_alterarClick(Sender: TObject);
begin
desabilita_botoes;
PageControl1.ActivePage := Tab_Cadastro;
 Tab_Cliente.Edit;
 Button1.Enabled := False;
 BitBtn3.Enabled := True;
 //DBEdit5.Date := Tab_ClienteDT_FECHA.Value;

 Q_mov.Close;
 Q_mov.sql.Clear;
 Q_mov.SQL.Add('select TAB_ITEM_CAIXA.*, Tab_caixa.id_caixa from tab_caixa');
 Q_mov.SQL.Add('inner join tab_item_caixa on(tab_item_caixa.id_caixa = tab_caixa.id_caixa)');
 Q_mov.SQL.Add('where tab_item_caixa.id_caixa = :p_nrcaixa');
 Q_mov.ParamByName('p_nrcaixa').AsInteger := Tab_ClienteID_CAIXA.AsInteger;
 Q_mov.Open;

 Q_mov.First;
while not Q_mov.eof do begin
    if Q_movTIPO_LANC.Text = 'C' then begin
    CurrencyEdit1.Value := CurrencyEdit1.Value + Q_movVL_LANC.Value;
    end;

    if Q_movTIPO_LANC.Text = 'D' then begin
     CurrencyEdit2.Value := CurrencyEdit2.Value + Q_movVL_LANC.Value;
    end;

Q_mov.Next;
end;
 CurrencyEdit3.Value := CurrencyEdit1.Value + Tab_ClienteVL_INICIAL.Value;
 CurrencyEdit3.Value := CurrencyEdit3.Value - CurrencyEdit2.Value;
 btn_comfirmar.Enabled := True;
end;

procedure TForm_Caixa.btn_cancelarClick(Sender: TObject);
begin
habilita_botoes;
PageControl1.ActivePage := Tab_Pesquisa;
Tab_Cliente.Cancel;
Button1.Enabled := True;
Destrava_campos;

CurrencyEdit1.Clear;
CurrencyEdit2.Clear;
CurrencyEdit3.Clear;
end;

procedure TForm_Caixa.btn_comfirmarClick(Sender: TObject);
begin
Tab_ClienteVL_FECHA.Value := DBEdit5.Date;
  Try
    Tab_Cliente.Post;
    DM.TBanco.CommitRetaining;
    Tab_Cliente.Close;
    Tab_Cliente.Open;
    ShowMessage('O registro foi gravado com sucesso!');
  Except
   DM.TBanco.Rollback;
   ShowMessage('Não foi possivel gravar dados!');
  Raise;
  end;
habilita_botoes;
PageControl1.ActivePage := Tab_Pesquisa;
Button1.Enabled := True;

CurrencyEdit1.Clear;
CurrencyEdit2.Clear;
CurrencyEdit3.Clear;
dm.Q_Caixa.Close;
dm.Q_Caixa.Open;
if form_menu.DateEdit1.Date = (date)then begin
  dm.Q_Caixa.First;
  while NOT dm.Q_caixa.Eof do begin
    if dm.Q_CaixaDT_INICIAL.Value = (date) then begin
      form_menu.Button1.Visible := FALSE;
    end;

    dm.Q_caixa.Next;
end;
end;

end;


procedure TForm_Caixa.FormActivate(Sender: TObject);
begin
PageControl1.ActivePage := Tab_Pesquisa;
end;

procedure TForm_Caixa.PageControl1Changing(Sender: TObject;
  var AllowChange: Boolean);
begin
AllowChange:= False;
end;

procedure TForm_Caixa.btn_excluirClick(Sender: TObject);
begin
if Application.MessageBox('Deseja Excluir o Cliente selecionado ?','SOF CONTROL', MB_yesno + MB_Iconquestion) = Id_YES then begin
   Tab_Cliente.Delete;
  end;


end;

procedure TForm_Caixa.FormCreate(Sender: TObject);
begin
Q_mov.Active := True;
Tab_Cliente.Open;

end;

procedure TForm_Caixa.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin


Try
Tab_Cliente.Close;
Except
ShowMessage('NÃO foi possivel fechar tabela Tab_Cliente!');
Raise;
end;
dm.Q_Caixa.Close;
dm.Q_Caixa.Open;
o := 0;
if form_menu.DateEdit1.Date = (date)then begin
  dm.Q_Caixa.First;
  while NOT dm.Q_caixa.Eof do begin
    if dm.Q_CaixaDT_INICIAL.Value = (date) then begin
    o := 1;
      form_menu.Button1.Visible := FALSE;
    end;

    dm.Q_caixa.Next;
end;
end;

if o = 0 then begin
form_menu.Button1.Visible := tRUE;
end;

end;

procedure TForm_Caixa.Button1Click(Sender: TObject);
begin
desabilita_botoes;
PageControl1.ActivePage := Tab_Cadastro;
Tab_Cliente.Open;
btn_comfirmar.Enabled := False;
Button1.Enabled := False;
Trava_campos;
//DBEdit5.Date := Tab_ClienteDT_FECHA.Value;

Q_mov.Close;
 Q_mov.sql.Clear;
 Q_mov.SQL.Add('select TAB_ITEM_CAIXA.*, Tab_caixa.id_caixa from tab_caixa');
 Q_mov.SQL.Add('inner join tab_item_caixa on(tab_item_caixa.id_caixa = tab_caixa.id_caixa)');
 Q_mov.SQL.Add('where tab_item_caixa.id_caixa = :p_nrcaixa');
 Q_mov.ParamByName('p_nrcaixa').AsInteger := Tab_ClienteID_CAIXA.AsInteger;
 Q_mov.Open;


 Q_mov.First;
while not Q_mov.eof do begin
    if Q_movTIPO_LANC.Text = 'C' then begin
    CurrencyEdit1.Value := CurrencyEdit1.Value + Q_movVL_LANC.Value;
    end;

    if Q_movTIPO_LANC.Text = 'D' then begin
     CurrencyEdit2.Value := CurrencyEdit2.Value + Q_movVL_LANC.Value;
    end;

Q_mov.Next;
end;
  CurrencyEdit3.Value := CurrencyEdit1.Value + Tab_ClienteVL_INICIAL.Value;
 CurrencyEdit3.Value := CurrencyEdit3.Value - CurrencyEdit2.Value;


end;

function Cpf(CPF_Text: string): boolean;
var n1,n2,n3,n4,n5,n6,n7,n8,n9: integer;
       d1,d2: integer;
       digitado, calculado: string;
begin
   n1:=StrToInt(CPF_Text[1]);
   n2:=StrToInt(CPF_Text[2]);
   n3:=StrToInt(CPF_Text[3]);
   n4:=StrToInt(CPF_Text[5]);
   n5:=StrToInt(CPF_Text[6]);
   n6:=StrToInt(CPF_Text[7]);
   n7:=StrToInt(CPF_Text[9]);
   n8:=StrToInt(CPF_Text[10]);
   n9:=StrToInt(CPF_Text[11]);
                     d1:=n9*2+n8*3+n7*4+n6*5+n5*6+n4*7+n3*8+n2*9+n1*10;
  d1:=11-(d1 mod 11);
   if d1>=10 then d1:=0;
        d2:=d1*2+n9*3+n8*4+n7*5+n6*6+n5*7+n4*8+n3*9+n2*10+n1*11;
    d2:=11-(d2 mod 11);
    if d2>=10 then
       d2:=0;
    calculado:=inttostr(d1)+inttostr(d2);
   digitado:=CPF_Text[13]+CPF_Text[14];
   if calculado=digitado then
       Cpf:=true
   else
       Cpf:=false;
end;



procedure TForm_Caixa.Edit1Change(Sender: TObject);
begin
Case  Rg_tipo.ItemIndex of
0: Tab_Cliente.Locate('id_caixa', Edit1.Text, [ loPartialKey, loCaseInsensitive]);
1: Tab_Cliente.Locate('dt_inicial', Edit1.Text, [ loPartialKey, loCaseInsensitive]);
end;
end;

procedure TForm_Caixa.Edit_quantidadeExit(Sender: TObject);
begin
//DBEdit10.Text := Edit_quantidade.Text;
//Edit_quantidade.Clear;
end;

procedure TForm_Caixa.TabSheet1Enter(Sender: TObject);
begin
//IBDataSet1.Locate('NR_CAIXA',DBEdit1.Text, [loPartialKey, loCaseInsensitive]);
end;

procedure TForm_Caixa.BitBtn1Click(Sender: TObject);
begin

CurrencyEdit1.Clear;
CurrencyEdit2.Clear;
CurrencyEdit3.Clear;

Q_mov.Close;
 Q_mov.sql.Clear;
 Q_mov.SQL.Add('select TAB_ITEM_CAIXA.*, Tab_caixa.id_caixa from tab_caixa');
 Q_mov.SQL.Add('inner join tab_item_caixa on(tab_item_caixa.id_caixa = tab_caixa.id_caixa)');
 Q_mov.SQL.Add('where tab_item_caixa.id_caixa = :p_nrcaixa');
 Q_mov.ParamByName('p_nrcaixa').AsInteger := Tab_ClienteID_CAIXA.AsInteger;
 Q_mov.Open;

  Q_mov.First;
while not Q_mov.eof do begin
    if Q_movTIPO_LANC.Text = 'C' then begin
    CurrencyEdit1.Value := CurrencyEdit1.Value + Q_movVL_LANC.Value;
    end;

    if Q_movTIPO_LANC.Text = 'D' then begin
     CurrencyEdit2.Value := CurrencyEdit2.Value + Q_movVL_LANC.Value;
    end;

Q_mov.Next;
end;
  CurrencyEdit3.Value := CurrencyEdit1.Value + Tab_ClienteVL_INICIAL.Value;
 CurrencyEdit3.Value := CurrencyEdit3.Value - CurrencyEdit2.Value;


PageControl1.ActivePage := Tab_Cadastro;
end;

procedure TForm_Caixa.BitBtn2Click(Sender: TObject);
begin


CurrencyEdit1.Clear;
CurrencyEdit2.Clear;
CurrencyEdit3.Clear;

 Q_mov.First;
while not Q_mov.eof do begin
    if Q_movTIPO_LANC.Text = 'C' then begin
    CurrencyEdit1.Value := CurrencyEdit1.Value + Q_movVL_LANC.Value;
    end;

    if Q_movTIPO_LANC.Text = 'D' then begin
     CurrencyEdit2.Value := CurrencyEdit2.Value + Q_movVL_LANC.Value;
    end;

Q_mov.Next;
end;
  CurrencyEdit3.Value := CurrencyEdit1.Value + Tab_ClienteVL_INICIAL.Value;
 CurrencyEdit3.Value := CurrencyEdit3.Value - CurrencyEdit2.Value;

PageControl1.ActivePage := Tab_Cadastro;
end;

procedure TForm_Caixa.DBGrid1DrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn;
  State: TGridDrawState);
begin
if Q_movTIPO_LANC.Value = 'D' then
   Dbgrid1.Canvas.Font.Color:= clred; // coloque aqui a cor desejada
   Dbgrid1.DefaultDrawDataCell(Rect, dbgrid1.columns[datacol].field, State);

if Q_movTIPO_LANC.Value = 'C' then
   Dbgrid1.Canvas.Font.Color:= clLime; // coloque aqui a cor desejada
   Dbgrid1.DefaultDrawDataCell(Rect, dbgrid1.columns[datacol].field, State);

end;

procedure TForm_Caixa.BitBtn3Click(Sender: TObject);
begin
if Application.MessageBox('Deseja Fechar o Caixa ?','SOF CONTROL', MB_yesno + MB_Iconquestion) = Id_YES then begin
   DBEdit4.Text := CurrencyEdit3.Text;
   DBEdit5.Text := DateToStr(date);
   
  end;

Try
    Tab_Cliente.Post;
    DM.TBanco.CommitRetaining;
    Tab_Cliente.Close;
    Tab_Cliente.Open;
    ShowMessage('O Caixa foi Fechado com sucesso!');
  Except
   DM.TBanco.Rollback;
   ShowMessage('Não foi possivel gravar dados!');
  Raise;
  end;

habilita_botoes;
PageControl1.ActivePage := Tab_Pesquisa;
Button1.Enabled := True;

CurrencyEdit1.Clear;
CurrencyEdit2.Clear;
CurrencyEdit3.Clear;
dm.Q_Caixa.Close;
dm.Q_Caixa.Open;
if form_menu.DateEdit1.Date = (date)then begin
  dm.Q_Caixa.First;
  while NOT dm.Q_caixa.Eof do begin
    if dm.Q_CaixaDT_INICIAL.Value = (date) then begin
      form_menu.Button1.Visible := FALSE;
    end;

    dm.Q_caixa.Next;
end;
end;


end;

end.
